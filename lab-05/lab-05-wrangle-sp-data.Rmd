---
title: "Lab 05 - La Quinta is Spanish for next to Denny's, Pt. 2"
subtitle: "Wrangling spatial data"
author: "Your Name"
output: 
  tufte::tufte_html:
    css: ../lab.css
    tufte_variant: "envisioned"
    highlight: pygments
  tufte::tufte_handout:
    latex_engine: xelatex
    highlight: pygments
    keep_tex: true
    citation_package: natbib
link-citations: true
---
```{r include = FALSE}
knitr::opts_chunk$set(eval = TRUE)
```
```{r fig.margin = TRUE, echo = FALSE}
knitr::include_graphics("img/mitch-hedgeberg-lqd.jpg")
```

## Introduction

In this lab we revisit the Denny's and La Quinta Inn and Suites data we visualized in Lab 04. Last time, we created maps to visually assess whether these establishments tend to be located near each other. This time, we'll take a more quantitative approach by actually calculating the distances between locations.

**This lab builds directly on Lab 04.** Make sure you understand the concepts from that lab before proceeding.

**Estimated time:** 90-120 minutes

## Learning Goals

By the end of this lab, you will be able to:

- Join two datasets using `full_join()`
- Work with custom functions in R
- Calculate distances between geographic coordinates
- Use `group_by()` and `summarise()` to find minimum values
- Apply the same analysis workflow to multiple datasets
- Compare distributions across different geographic regions

## Prerequisites

Before you begin, make sure you have:

- ‚úÖ Completed Lab 04
- ‚úÖ Understand latitude and longitude coordinates
- ‚úÖ Watched lectures on joins and functions
- ‚úÖ Forked the lab-instructions repository

---

# Getting Started

Navigate to your forked `lab-instructions` repository in JupyterHub, open the `Lab05` folder, and open the R Markdown document `lab-05.Rmd`.

## Verify Your Setup

Before proceeding:

  Step 1. Open `lab-05.Rmd` in RStudio
  
  Step 2. Check that the Git pane shows YOUR username (not the course organization)
  
  Step 3. Click **Knit** to make sure the document compiles

## Warm Up

Before we introduce the data, let's warm up with some simple exercises.

**Step 1:** Update the YAML, changing the author name to your name.

**Step 2:** Knit the document.

**Step 3:** Commit your changes with message "Updated author name".

**Step 4:** Push to GitHub and verify the changes are visible in your repo.

üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed warm up", and push your changes.**

---

## Packages

We'll use the **tidyverse** package for much of the data wrangling and visualisation and the data lives in the **dsbox** package. These packages are already installed for you. You can load them by running the following in your Console:
```{r load-packages, message = FALSE}
library(tidyverse) 
library(dsbox) 
```

## Data

Remember that the datasets we'll use are called `dennys` and `laquinta` from the **dsbox** package. Since the datasets are distributed with the package, we don't need to load them separately; they become available to us when we load the package. You can find out more about the datasets by inspecting their documentation, which you can access by running `?dennys` and `?laquinta` in the Console or using the Help menu in RStudio to search for `dennys` or `laquinta`. You can also find this information [here](https://rstudio-education.github.io/dsbox/reference/dennys.html) and [here](https://rstudio-education.github.io/dsbox/reference/laquinta.html).

**‚úì Checkpoint:** Run `glimpse(dennys)` and `glimpse(laquinta)` in your Console to verify the data loaded correctly.

---

# Exercises

## Filtering for Alaska

We'll start our analysis by focusing on one state: Alaska.

## Exercise 1

Filter the Denny's dataframe for Alaska (AK) and save the result as `dn_ak`. How many Denny's locations are there in Alaska?
```{r filter-dennys-ak}
dn_ak <- dennys %>%           # Start with dennys dataset
  filter(state == "AK")        # Keep only rows where state is AK
```

**What this code does:**

- Takes the `dennys` dataset
- Filters for rows where `state` equals "AK"
- Saves the result as `dn_ak` using the assignment operator `<-`

**How many Denny's locations are in Alaska?** Use inline code to report the number.

**Your answer:** There are _____ Denny's locations in Alaska.

**Hint:** You can use inline code with `nrow(dn_ak)` to get the count.

---

## Exercise 2

Filter the La Quinta dataframe for Alaska (AK) and save the result as `lq_ak`. How many La Quinta locations are there in Alaska?
```{r filter-laquinta-ak}
lq_ak <- laquinta %>%         # Start with laquinta dataset
  filter(state == "AK")        # Keep only rows where state is AK
```

**What this code does:**

- Takes the `laquinta` dataset
- Filters for rows where `state` equals "AK"
- Saves the result as `lq_ak`

**How many La Quinta locations are in Alaska?** Use inline code to report the number.

**Your answer:** There are _____ La Quinta locations in Alaska.

üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercises 1-2", and push your changes.**

---

## Understanding Pairings

Next we'll calculate the distance between all Denny's and all La Quinta locations in Alaska. Let's take this step by step:

**Step 1:** There are 3 Denny's and 2 La Quinta locations in Alaska. (If you answered differently above, you might want to recheck your answers.)

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.001.png){width="300px" height="300px"}

**Step 2:** Let's focus on the first Denny's location. We'll need to calculate two distances for it: (1) distance between Denny's 1 and La Quinta 1 and (2) distance between Denny's 1 and La Quinta 2.

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.002.png){width="300px" height="150px"}

**Step 3:** Now let's consider all Denny's locations.

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.003.png){width="300px" height="450px"}

## Exercise 3

How many pairings are there between all Denny's and all La Quinta locations in Alaska, i.e. how many distances do we need to calculate between the locations of these establishments in Alaska?

**Hint:** If there are 3 Denny's and 2 La Quinta locations, how many total pairings are there?

**Your answer:** There are _____ pairings between Denny's and La Quinta locations in Alaska.

---

## Joining Data Frames

In order to calculate these distances we need to first restructure our data to pair the Denny's and La Quinta locations. To do so, we will join the two data frames. 

We have six join options in R. Each of these join functions take at least three arguments: `x`, `y`, and `by`.

- `x` and `y` are data frames to join
- `by` is the variable(s) to join by

Four of these join functions combine variables from the two data frames:
```{marginfigure}
These are called **mutating joins**.
```

- `inner_join()`: return all rows from `x` where there are matching values in `y`, and all columns from `x` and `y`.

- `left_join()`: return all rows from `x`, and all columns from `x` and `y`. Rows in x with no match in y will have NA values in the new columns.

- `right_join()`: return all rows from `y`, and all columns from `x` and `y`. Rows in y with no match in x will have NA values in the new columns.

- `full_join()`: return all rows and all columns from both `x` and `y`. Where there are not matching values, returns NA for the one missing.

And the other two join functions only keep cases from the left-hand data frame, and are called **filtering joins**. We'll learn about these another time but you can find out more about the join functions in the help files for any one of them, e.g. `?full_join`.

In practice we mostly use mutating joins. In this case we want to keep all rows and columns from both `dn_ak` and `lq_ak` data frames. So we will use a `full_join`.

![Full join of Denny's and La Quinta locations in AK](img/dennys-laquinta-sketches/dennys-laquinta-sketches.004.png){height="300px" width="300px"}

Let's join the data on Denny's and La Quinta locations in Alaska:
```{r join-ak-data}
dn_lq_ak <- full_join(dn_ak, lq_ak, by = "state")  # Join the two datasets
```

**What this code does:**

- Takes `dn_ak` (the first data frame) and `lq_ak` (the second data frame)
- Joins them together using the `state` variable as the matching key
- Since both datasets have `state = "AK"`, every row in `dn_ak` gets matched with every row in `lq_ak`
- Creates all possible pairings (this is called a Cartesian product when joining on a constant value)
- Saves the result as `dn_lq_ak`

**View the result:** Run `dn_lq_ak` in your Console to see what the joined data looks like.

---

## Exercise 4

How many observations are in the joined `dn_lq_ak` data frame? What are the names of the variables in this data frame?

**Your answers:**

**Number of observations:** _____

**Variable names:** Run `names(dn_lq_ak)` in your Console and list them below:



**Note about variable names:** You'll notice `.x` and `.y` suffixes on many variables. The `.x` means the variable comes from the first data frame (`dn_ak`), and `.y` means it comes from the second data frame (`lq_ak`). These suffixes are added because both data frames have variables with the same names (like `address`, `city`, `longitude`, `latitude`), and R can't have duplicate column names.

üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercises 3-4", and push your changes.**

---

## Calculating Distances

Now that we have the data in the format we wanted, all that is left is to calculate the distances between the pairs.

## Exercise 5

What function from the tidyverse do we use to add a new variable to a data frame while keeping the existing variables?

**Your answer:** _____

---

One way of calculating the distance between any two points on the earth is to use the Haversine distance formula. This formula takes into account the fact that the earth is not flat, but instead spherical.

This function is not available in base R, but here it is as a custom function we can use:
```{r haversine-function}
haversine <- function(long1, lat1, long2, lat2, round = 3) {
  # convert to radians
  long1 = long1 * pi / 180
  lat1  = lat1  * pi / 180
  long2 = long2 * pi / 180
  lat2  = lat2  * pi / 180
  
  R = 6371 # Earth mean radius in km
  
  a = sin((lat2 - lat1)/2)^2 + cos(lat1) * cos(lat2) * sin((long2 - long1)/2)^2
  d = R * 2 * asin(sqrt(a))
  
  return( round(d,round) ) # distance in km
}
```

**What this function does:**

- Takes 5 arguments: longitude and latitude for two locations, plus a rounding parameter
- Converts coordinates from degrees to radians (required for trig functions)
- Uses the Haversine formula to calculate the great-circle distance
- Returns the distance in kilometers, rounded to 3 decimal places by default

**You don't need to understand the math!** Just know that you give it two sets of coordinates and it gives you the distance in kilometers.

---

## Exercise 6

Calculate the distances between all pairs of Denny's and La Quinta locations and save this variable as `distance`. Make sure to save this variable in the `dn_lq_ak` data frame so that you can use it later.

**Remember:** Use the `<-` assignment operator to save the result back to `dn_lq_ak`, just like in Lab 04 when we added the `country` variable.
```{r calculate-distances, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!
dn_lq_ak <- dn_lq_ak %>%
  mutate(distance = haversine(
    long1 = ___,      # longitude from Denny's (has .x suffix)
    lat1 = ___,       # latitude from Denny's (has .x suffix)
    long2 = ___,      # longitude from La Quinta (has .y suffix)
    lat2 = ___        # latitude from La Quinta (has .y suffix)
  ))
```

**Hints:**

- Denny's coordinates have `.x` suffix: `longitude.x` and `latitude.x`
- La Quinta coordinates have `.y` suffix: `longitude.y` and `latitude.y`
- Don't forget to save the result back to `dn_lq_ak` using `<-`

**Verify it worked:** Run `names(dn_lq_ak)` - you should see `distance` as one of the variables.

---

## Exercise 7

Calculate the minimum distance between a Denny's and La Quinta for each Denny's location. To do so we group by Denny's locations and calculate a new variable that stores the information for the minimum distance.

```{r min-distance-ak, eval = FALSE}
dn_lq_ak_mindist <- dn_lq_ak %>%
  group_by(address.x) %>%              # Group by each Denny's address
  summarise(closest = min(distance))   # Find the minimum distance for each group
```

**What this code does:**

- Takes the `dn_lq_ak` dataset (which has all pairings)
- Groups by `address.x` (each unique Denny's location)
- For each Denny's, finds the minimum distance to any La Quinta
- Creates a new dataset with one row per Denny's showing its closest La Quinta distance
- Saves this as `dn_lq_ak_mindist`

**View the result:** Run `dn_lq_ak_mindist` in your Console to see the minimum distances.

üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercises 5-7", and push your changes.**

---

## Exercise 8

Describe the distribution of the distances between Denny's and the nearest La Quinta locations in Alaska. Also include an appropriate visualization and relevant summary statistics.

**Create a visualization:**
```{r visualize-ak-distances, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!
ggplot(data = dn_lq_ak_mindist, aes(x = ___)) +
  geom_histogram(binwidth = ___) +
  labs(
    title = "___",
    x = "___",
    y = "___"
  )
```

**Calculate summary statistics:**
```{r summary-ak-distances, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!
dn_lq_ak_mindist %>%
  summarise(
    min = min(___),
    max = max(___),
    mean = mean(___),
    median = median(___),
    sd = sd(___)
  )
```

**Describe the distribution:**

Consider shape, center, spread, and any unusual observations.

**Your answer:**



üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercise 8", and push your changes.**

---

## Repeat the Analysis for Other States

Now that you've completed the analysis for Alaska, you'll repeat the same steps for other states. Use the Alaska analysis as a template!

## Exercise 9

Repeat the same analysis for North Carolina:

  Step (i) filter Denny's and La Quinta Data Frames for NC
  
  Step (ii) join these data frames to get a complete list of all possible pairings
  
  Step (iii) calculate the distances between all possible pairings of Denny's and La Quinta in NC
  
  Step (iv) find the minimum distance between each Denny's and La Quinta location
  
  Step (v) visualize and describe the distribution of these shortest distances using appropriate summary statistics

**Here's a template you can adapt from the Alaska code:**
```{r nc-analysis, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!

# (i) Filter for NC
dn_nc <- dennys %>%
  filter(state == "___")

lq_nc <- laquinta %>%
  filter(state == "___")

# (ii) Join the data
dn_lq_nc <- full_join(___, ___, by = "state")

# (iii) Calculate distances
dn_lq_nc <- dn_lq_nc %>%
  mutate(distance = haversine(
    long1 = ___,
    lat1 = ___,
    long2 = ___,
    lat2 = ___
  ))

# (iv) Find minimum distances
dn_lq_nc_mindist <- dn_lq_nc %>%
  group_by(___) %>%
  summarise(closest = min(___))

# (v) Visualize
ggplot(data = dn_lq_nc_mindist, aes(x = ___)) +
  geom_histogram(binwidth = ___) +
  labs(
    title = "___",
    x = "___",
    y = "___"
  )

# Summary statistics
dn_lq_nc_mindist %>%
  summarise(
    min = min(closest),
    max = max(closest),
    mean = mean(closest),
    median = median(closest),
    sd = sd(closest)
  )
```

**Describe the distribution for North Carolina:**



üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercise 9", and push your changes.**

---

## Exercise 10

Repeat the same analysis for Texas.

**Adapt the template from Exercise 9, changing NC to TX:**
```{r tx-analysis, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!
# Your code here - adapt from Exercise 9
```

**Describe the distribution for Texas:**


üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercise 10", and push your changes.**

---

## Exercise 11

Repeat the same analysis for a state of your choosing, different than the ones we covered so far.

**Which state did you choose?** _____
```{r your-state-analysis, eval = FALSE}
# Remember to change eval=FALSE to eval=TRUE!
# Your code here - adapt from Exercise 9
```

**Describe the distribution for your chosen state:**


üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercise 11", and push your changes.**

---

## Exercise 12

Among the states you examined, where is Mitch Hedberg's joke most likely to hold true? Explain your reasoning.

**Create a comparison table:**

| State | Median Distance (km) | Mean Distance (km) | Notes |
|:------|:---------------------|:-------------------|:------|
| Alaska |  |  |  |
| North Carolina |  |  |  |
| Texas |  |  |  |
| (Your state) |  |  |  |

**Your analysis:**

Which state has the smallest distances on average? What does this tell us about where the joke holds true?



üß∂ ‚úÖ ‚¨ÜÔ∏è **Knit, commit with message "Completed Exercise 12", and push your changes.**

---

## Common Errors and Troubleshooting

**Join errors:**

- **Too many/too few rows after joining** ‚Üí When joining on `state` where both datasets have the same state value, you get a Cartesian product (every row paired with every row). This is what we want!
- **Missing .x and .y suffixes** ‚Üí These are automatically added when both datasets have the same variable names
- **Error: "object not found"** ‚Üí Make sure you've run all previous code chunks that create the datasets

**Distance calculation errors:**

- **Error: "could not find function 'haversine'"** ‚Üí Make sure you ran the code chunk that defines the haversine function
- **Distance values seem wrong** ‚Üí Check that you're using the correct .x and .y suffixes for coordinates
- **NA values in distance** ‚Üí Check that there are no missing latitude/longitude values

**Group and summarize errors:**

- **Error with `group_by()`** ‚Üí Make sure you're grouping by the Denny's address (with .x suffix)
- **Wrong minimum values** ‚Üí Make sure you're using `min(distance)` not `min(closest)`

**Assignment errors:**

- **New variable not saved** ‚Üí Remember to use `<-` to save the mutated dataset back to the same name
- **Can't find variable in next step** ‚Üí You forgot the assignment operator in a previous step

**General issues:**

- **Code chunk not running** ‚Üí Make sure you changed `eval=FALSE` to `eval=TRUE`
- **Can't knit document** ‚Üí Check for errors in your code chunks; run them individually to find the problem

---

**Key insight:** Mitch Hedberg's joke holds true to different degrees in different states! By calculating actual distances, we found that the proximity of Denny's and La Quinta locations varies significantly by state. Some states show very close clustering (supporting the joke), while others show much more spread out locations.

**Looking ahead:** This type of analysis - filtering, joining, calculating, summarizing, and comparing - is a common pattern in data science. You can apply this same workflow to many different types of questions!

---

**To submit to Canvas:**

Step 1.  In RStudio, click the **Knit** dropdown menu (next to the Knit button)

Step 2.  Select **Knit to tufte_handout** to generate a PDF

Step 3.  Download the PDF file from the Files pane

Step 4.  Upload the PDF to Canvas

**‚úì Final Checkpoint:** Visit your GitHub repo one more time to confirm all your work is there. We will grade what we see in your repo on GitHub!